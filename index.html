<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Automation Hub</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* RESET & LAYOUT */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { display: flex; height: 100vh; background-color: #f4f6f9; }

        /* --- SIDEBAR STYLING --- */
        .sidebar {
            width: 260px;
            background-color: #2c3e50; /* Dark Blue */
            color: white;
            display: flex;
            flex-direction: column;
            padding-top: 20px;
            position: fixed;
            height: 100%;
            left: 0; top: 0;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        .logo {
            text-align: center;
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 30px;
            border-bottom: 1px solid #34495e;
            padding-bottom: 15px;
        }
        .logo i { color: #2ecc71; margin-right: 10px; }

        .menu { list-style: none; width: 100%; }
        .menu li { width: 100%; }
        
        .menu a {
            display: flex;
            align-items: center;
            padding: 15px 25px;
            color: #bdc3c7;
            text-decoration: none;
            font-size: 16px;
            transition: 0.3s;
        }

        .menu a:hover, .menu a.active {
            background-color: #34495e;
            color: #ffffff;
            border-left: 5px solid #2ecc71; /* Green Accent */
        }

        .menu a i { margin-right: 15px; width: 20px; text-align: center; }

        /* --- MAIN CONTENT AREA --- */
        .main-content {
            margin-left: 260px; /* Sidebar width */
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            width: calc(100% - 260px);
        }

        .header-title {
            font-size: 24px;
            color: #333;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
        }

        /* --- CARDS & BOXES --- */
        .card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .upload-area {
            border: 2px dashed #3498db;
            padding: 30px;
            text-align: center;
            background: #f0f8ff;
            border-radius: 8px;
            cursor: pointer;
        }
        .upload-area:hover { background: #e6f2ff; }
        
        /* TABLE STYLES */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        th { background: #2c3e50; color: white; padding: 12px; text-align: left; }
        td { border-bottom: 1px solid #eee; padding: 10px; }
        
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .bg-green { background: #d4edda; color: #155724; }
        .bg-red { background: #f8d7da; color: #721c24; }

        /* INPUTS & BUTTONS */
        .input-box { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 15px; font-weight: bold; color: white; }
        .btn-primary { background: #27ae60; }
        .btn-primary:hover { background: #219150; }
        
        /* Sections Visibility */
        .section { display: none; }
        .section.active { display: block; }

    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="logo">
            <i class="fas fa-chart-pie"></i> Data Stack
        </div>
        <ul class="menu">
            <li><a href="#" class="active" onclick="showSection('dashboard', this)">
                <i class="fas fa-home"></i> Dashboard
            </a></li>
            <li><a href="#" onclick="showSection('mapping', this)">
                <i class="fas fa-sliders-h"></i> Tools & Split
            </a></li>
            <li><a href="#" onclick="showSection('database', this)">
                <i class="fas fa-database"></i> Database View
            </a></li>
            <li><a href="#" onclick="showSection('settings', this)">
                <i class="fas fa-cog"></i> Settings
            </a></li>
        </ul>
    </nav>

    <main class="main-content">
        
        <div id="dashboard" class="section active">
            <h2 class="header-title">üìÇ Dashboard - File Processor</h2>
            
            <div class="card">
                <h3>Step 1: Upload Excel File</h3>
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 40px; color: #3498db; margin-bottom: 10px;"></i>
                    <p>Click here to select file (.xlsx, .xls)</p>
                    <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" hidden onchange="loadAndPreview()" />
                    <p id="fileName" style="margin-top: 10px; font-weight: bold; color: #2c3e50;"></p>
                </div>
            </div>

            <div id="controlPanel" class="card" style="display: none;">
                <h3>Step 2: Map & Control Columns</h3>
                <table id="mappingTable">
                    <thead>
                        <tr>
                            <th>Column Name</th>
                            <th>Status</th>
                            <th style="text-align:center">Set as Method</th>
                            <th>Split By (Delimiter)</th>
                            <th>Rename / Fill</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="processAndDownload()">
                        <i class="fas fa-file-download"></i> Generate Report
                    </button>
                    <p id="msg" style="margin-top:10px; color:blue;"></p>
                </div>
            </div>
        </div>

        <div id="mapping" class="section">
            <h2 class="header-title">üõ†Ô∏è Tools</h2>
            <div class="card">
                <p>Advanced splitting tools coming here...</p>
            </div>
        </div>

        <div id="database" class="section">
            <h2 class="header-title">üóÑÔ∏è Database</h2>
            <div class="card">
                <p>Your Google Sheet Backend is connected.</p>
                <a href="https://docs.google.com/spreadsheets" target="_blank" style="color:#3498db; text-decoration:none;">
                    <i class="fas fa-external-link-alt"></i> Open Google Sheet
                </a>
            </div>
        </div>

    </main>

    <script>
        // GLOBAL VARIABLES
        let rawData = [];
        let headers = [];
        let workbookName = "";

        // --- SIDEBAR NAVIGATION ---
        function showSection(sectionId, element) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            
            // Update Menu Active State
            document.querySelectorAll('.menu a').forEach(link => link.classList.remove('active'));
            element.classList.add('active');
        }

        // --- FILE HANDLING ---
        function loadAndPreview() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) return;

            document.getElementById('fileName').innerText = "Selected: " + file.name;
            workbookName = file.name.split('.')[0];
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                rawData = XLSX.utils.sheet_to_json(firstSheet, {defval: ""});
                
                if (rawData.length === 0) { alert("File is empty!"); return; }
                headers = Object.keys(rawData[0]);
                
                renderControlTable();
                document.getElementById('controlPanel').style.display = 'block';
            };
            reader.readAsArrayBuffer(file);
        }

        function renderControlTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = "";

            headers.forEach((header, index) => {
                let hasData = rawData.some(row => row[header] && row[header].toString().trim() !== "");
                let statusBadge = hasData 
                    ? `<span class="status-badge bg-green">Has Data</span>` 
                    : `<span class="status-badge bg-red">Blank</span>`;

                let tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${header}</strong></td>
                    <td>${statusBadge}</td>
                    <td style="text-align:center;">
                        <input type="radio" name="methodGroup" value="${header}" ${header.toLowerCase().includes('vch') ? 'checked' : ''}>
                    </td>
                    <td><input type="text" class="input-box" id="split-${index}" placeholder=": or -"></td>
                    <td><input type="text" class="input-box" id="fill-${index}" placeholder="New Value"></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function processAndDownload() {
            const msgDiv = document.getElementById('msg');
            msgDiv.innerText = "Processing...";

            // 1. Get Rules
            let selectedMethodCol = document.querySelector('input[name="methodGroup"]:checked')?.value || "";
            let splitRules = {};
            
            headers.forEach((header, index) => {
                let sVal = document.getElementById(`split-${index}`).value;
                if(sVal) splitRules[header] = sVal;
            });

            // 2. Identify Columns
            let colDate = headers.find(h => h.toLowerCase().includes("date"));
            let colDebit = headers.find(h => h.toLowerCase().includes("debit"));
            let colCredit = headers.find(h => h.toLowerCase().includes("credit"));
            let colLedger = headers.find(h => h.toLowerCase().includes("ledger") || h.toLowerCase().includes("particulars"));

            if (!colDate || !colDebit || !colCredit || !colLedger) {
                alert("Error: Missing Date, Debit, Credit, or Ledger columns.");
                msgDiv.innerText = "";
                return;
            }

            // 3. Transform Data
            let expensesData = rawData.map(row => {
                let dbt = parseFloat(row[colDebit]) || 0;
                let crd = parseFloat(row[colCredit]) || 0;
                
                let reasonVal = "";
                for (let [hName, delim] of Object.entries(splitRules)) {
                    let cellData = row[hName] ? row[hName].toString() : "";
                    if (cellData.includes(delim)) {
                        reasonVal = cellData.split(delim)[1].trim();
                        break; 
                    }
                }

                return {
                    "Date": row[colDate],
                    "Method": selectedMethodCol ? row[selectedMethodCol] : "",
                    "Amount": (dbt - crd).toFixed(2),
                    "Nature": row[colLedger],
                    "Reason": reasonVal
                };
            });

            // 4. Download Excel
            let newWs = XLSX.utils.json_to_sheet(expensesData);
            let newWb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(newWb, newWs, "Expenses");
            XLSX.writeFile(newWb, `${workbookName}_Report.xlsx`);

            msgDiv.innerText = "‚úÖ Report Downloaded Successfully!";
        }
    </script>
</body>
</html>
