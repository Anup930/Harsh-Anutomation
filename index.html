<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Stack Automation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* (Keep your existing CSS for Sidebar/Layout here) */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { display: flex; height: 100vh; background-color: #f4f6f9; }
        .sidebar { width: 260px; background-color: #2c3e50; color: white; display: flex; flex-direction: column; padding-top: 20px; position: fixed; height: 100%; }
        .logo { text-align: center; font-size: 22px; font-weight: bold; margin-bottom: 30px; border-bottom: 1px solid #34495e; padding-bottom: 15px; }
        .menu a { display: flex; align-items: center; padding: 15px 25px; color: #bdc3c7; text-decoration: none; font-size: 16px; transition: 0.3s; cursor: pointer; }
        .menu a:hover, .menu a.active { background-color: #34495e; color: #ffffff; border-left: 5px solid #2ecc71; }
        .menu a i { margin-right: 15px; width: 20px; text-align: center; }
        .main-content { margin-left: 260px; flex: 1; padding: 30px; overflow-y: auto; }
        .card { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; }
        .btn-orange { background: #e67e22; }
        .btn-orange:hover { background: #d35400; }
        .section { display: none; }
        .section.active { display: block; }
        
        /* Specific Styles for Mapping */
        .mapping-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px; }
        .map-item label { display: block; font-size: 12px; font-weight: bold; color: #555; margin-bottom: 5px; }
        .map-item select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="logo"><i class="fas fa-layer-group"></i> Data Stack</div>
        <div class="menu">
            <a onclick="showSection('dashboard')" class="active"><i class="fas fa-home"></i> Dashboard</a>
            <a onclick="showSection('ledger')"><i class="fas fa-broom"></i> Clean Ledger (Tally)</a>
            <a onclick="showSection('settings')"><i class="fas fa-cog"></i> Settings</a>
        </div>
    </nav>

    <main class="main-content">

        <div id="dashboard" class="section active">
            <h2>Welcome Back, Anup!</h2>
            <p>Select an option from the sidebar to begin.</p>
        </div>

        <div id="ledger" class="section">
            <h2 style="border-bottom: 2px solid #e67e22; padding-bottom: 10px; color: #e67e22;">
                ðŸ§¹ Tally Ledger Cleaner
            </h2>
            
            <div class="card">
                <h3>1. Upload Raw Ledger Export</h3>
                <p style="font-size: 13px; color: #666;">Supports files with merged rows and "(as per details)".</p>
                <input type="file" id="ledgerInput" accept=".xlsx, .xls" onchange="loadLedger()" style="margin-top:10px;">
            </div>

            <div id="mappingArea" class="card" style="display:none;">
                <h3>2. Map Columns (Control)</h3>
                <p>We detected the following headers. Verify them:</p>
                
                <div class="mapping-grid">
                    <div class="map-item">
                        <label>Date Column</label>
                        <select id="mapDate"></select>
                    </div>
                    <div class="map-item">
                        <label>Particulars (Ledger Name)</label>
                        <select id="mapPart"></select>
                    </div>
                    <div class="map-item">
                        <label>Vch Type</label>
                        <select id="mapVchType"></select>
                    </div>
                    <div class="map-item">
                        <label>Vch No</label>
                        <select id="mapVchNo"></select>
                    </div>
                    <div class="map-item">
                        <label>Debit Amount</label>
                        <select id="mapDebit"></select>
                    </div>
                    <div class="map-item">
                        <label>Credit Amount</label>
                        <select id="mapCredit"></select>
                    </div>
                    <div class="map-item">
                        <label>Narration (Optional)</label>
                        <select id="mapNarration"></select>
                    </div>
                </div>

                <div style="margin-top: 20px; text-align: right;">
                    <button class="btn btn-orange" onclick="processLedger()">
                        <i class="fas fa-file-export"></i> Clean & Download
                    </button>
                </div>
                <p id="statusMsg" style="margin-top:10px; font-weight:bold;"></p>
            </div>
        </div>

    </main>

    <script>
        // --- NAVIGATION ---
        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.menu a').forEach(a => a.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        // --- GLOBAL VARIABLES ---
        let rawData = [];
        let headers = [];
        let fileName = "";

        // --- 1. LOAD FILE & AUTO-DETECT HEADERS ---
        function loadLedger() {
            const file = document.getElementById('ledgerInput').files[0];
            if (!file) return;
            fileName = file.name.split('.')[0];

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                
                // Convert to array of arrays (A1:RowN)
                rawData = XLSX.utils.sheet_to_json(sheet, {header: 1, defval: ""});
                
                detectHeadersAndMap();
            };
            reader.readAsArrayBuffer(file);
        }

        function detectHeadersAndMap() {
            // Find the header row (Scan first 20 rows for "Date" and "Particulars")
            let headerRowIdx = -1;
            for(let i=0; i<20 && i<rawData.length; i++) {
                let rowStr = rawData[i].join(" ").toLowerCase();
                if(rowStr.includes("date") && (rowStr.includes("particulars") || rowStr.includes("ledger"))) {
                    headerRowIdx = i;
                    break;
                }
            }

            if(headerRowIdx === -1) {
                alert("Could not find Header row. Please ensure file has 'Date' and 'Particulars'.");
                return;
            }

            // Extract Headers
            headers = rawData[headerRowIdx];
            rawData = rawData.slice(headerRowIdx + 1); // Remove top rows

            // Populate Dropdowns
            const selects = ['mapDate', 'mapPart', 'mapVchType', 'mapVchNo', 'mapDebit', 'mapCredit', 'mapNarration'];
            selects.forEach(id => {
                const sel = document.getElementById(id);
                sel.innerHTML = '<option value="-1">-- Select --</option>';
                headers.forEach((h, index) => {
                    let opt = document.createElement('option');
                    opt.value = index;
                    opt.text = h || `Col ${index+1}`;
                    sel.appendChild(opt);
                });
            });

            // Auto-Select based on name
            autoSelect('mapDate', 'date');
            autoSelect('mapPart', ['particulars', 'ledger']);
            autoSelect('mapVchType', 'type');
            autoSelect('mapVchNo', 'no');
            autoSelect('mapDebit', 'debit');
            autoSelect('mapCredit', 'credit');
            autoSelect('mapNarration', 'narration');

            document.getElementById('mappingArea').style.display = 'block';
        }

        function autoSelect(elementId, keywords) {
            const sel = document.getElementById(elementId);
            if(!Array.isArray(keywords)) keywords = [keywords];
            
            for(let i=0; i<sel.options.length; i++) {
                let txt = sel.options[i].text.toLowerCase();
                if(keywords.some(k => txt.includes(k))) {
                    sel.selectedIndex = i;
                    return;
                }
            }
        }

        // --- 2. PROCESS LEDGER (VBA Logic Conversion) ---
        function processLedger() {
            const msg = document.getElementById('statusMsg');
            msg.innerText = "Processing...";
            msg.style.color = "blue";

            // Get Indexes from UI
            const idxDate = parseInt(document.getElementById('mapDate').value);
            const idxPart = parseInt(document.getElementById('mapPart').value);
            const idxVchType = parseInt(document.getElementById('mapVchType').value);
            const idxVchNo = parseInt(document.getElementById('mapVchNo').value);
            const idxDebit = parseInt(document.getElementById('mapDebit').value);
            const idxCredit = parseInt(document.getElementById('mapCredit').value);
            const idxNarration = parseInt(document.getElementById('mapNarration').value);

            if(idxDate === -1 || idxPart === -1) {
                alert("Date and Particulars columns are mandatory.");
                return;
            }

            // --- THE CORE ALGORITHM (Replacing MakeData & cleanLedger_v2) ---
            let outputData = [];
            
            // State Variables (to hold Parent Data for Fill Down)
            let lastDate = null;
            let lastVchType = "";
            let lastVchNo = "";
            let lastNarration = "";
            
            // Buffer to hold rows of a single transaction block
            let transactionBlock = [];

            // Helper to Flush Buffer
            function processBlock() {
                if(transactionBlock.length === 0) return;

                // Find Narration in the block (Rows with text but no Amount)
                let blockNarration = "";
                transactionBlock.forEach(row => {
                    let d = parseFloat(row[idxDebit]) || 0;
                    let c = parseFloat(row[idxCredit]) || 0;
                    let txt = row[idxPart] ? row[idxPart].toString() : "";
                    
                    // If no amount and has text, assume it's narration (or part of it)
                    if(d === 0 && c === 0 && txt.length > 0 && !txt.includes("(as per details)")) {
                        blockNarration += " " + txt;
                    }
                });

                // Process Rows
                transactionBlock.forEach(row => {
                    let pText = row[idxPart] ? row[idxPart].toString() : "";
                    
                    // Skip "(as per details)" header row
                    if(pText.toLowerCase().includes("(as per details)")) return;

                    let debit = parseFloat(row[idxDebit]) || 0;
                    let credit = parseFloat(row[idxCredit]) || 0;

                    // Only add rows that have financial impact
                    if(debit !== 0 || credit !== 0) {
                        outputData.push({
                            "Date": formatDate(lastDate),
                            "Particulars": pText,
                            "Vch Type": lastVchType,
                            "Vch No": lastVchNo,
                            "Debit": debit,
                            "Credit": credit,
                            "Net": debit - credit,
                            "Narration": blockNarration.trim() || lastNarration
                        });
                    }
                });
                transactionBlock = [];
            }

            // Loop through Raw Data
            for(let i=0; i < rawData.length; i++) {
                let row = rawData[i];
                let rDate = row[idxDate];
                let rPart = row[idxPart];

                // 1. Detect New Transaction Group (If Date is present)
                if(rDate) {
                    processBlock(); // Finish previous block
                    
                    lastDate = rDate;
                    if(idxVchType > -1) lastVchType = row[idxVchType];
                    if(idxVchNo > -1) lastVchNo = row[idxVchNo];
                    
                    // Add current row to new block
                    transactionBlock.push(row);
                } 
                // 2. Child Rows (No Date)
                else {
                    // Only add if Particulars exists (ignore completely empty rows)
                    if(rPart || (row[idxDebit] || row[idxCredit])) {
                        transactionBlock.push(row);
                    }
                }
            }
            processBlock(); // Flush last block

            // --- DOWNLOAD ---
            const ws = XLSX.utils.json_to_sheet(outputData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "CleanLedger");
            XLSX.writeFile(wb, `${fileName}_Cleaned.xlsx`);

            msg.innerText = "âœ… Done! File Downloaded.";
            msg.style.color = "green";
        }

        // Helper: Convert Excel Serial Date to JS Date String
        function formatDate(serial) {
            if(!serial) return "";
            if(typeof serial === 'string') return serial; // Already string
            const date = new Date(Math.round((serial - 25569)*86400*1000));
            return date.toLocaleDateString('en-GB'); // DD/MM/YYYY
        }

    </script>
</body>
</html>
